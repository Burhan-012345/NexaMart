{% extends "main/base.html" %} {% block title %}Order Confirmation{% endblock %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-navy text-white text-center py-4">
          <i class="fas fa-check-circle fa-3x mb-3 text-yellow"></i>
          <h2 class="mb-0">Order Confirmed!</h2>
          <p class="mb-0 mt-2">Thank you for your purchase!</p>
        </div>
        <div class="card-body text-center p-4">
          <!-- QR Code Invoice Section -->
          <div class="row justify-content-center mb-5">
            <div class="col-md-6">
              <div class="card border-yellow">
                <div class="card-header bg-yellow text-navy">
                  <h5 class="mb-0">
                    <i class="fas fa-qrcode me-2"></i>Digital Invoice QR Code
                  </h5>
                </div>
                <div class="card-body text-center">
                  <!-- QR Code Container -->
                  <div id="qrcode-container" class="mb-3">
                    <div
                      id="qrcode"
                      style="
                        width: 220px;
                        height: 220px;
                        margin: 0 auto;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                    >
                      <div class="text-center">
                        <div class="spinner-border text-navy" role="status">
                          <span class="visually-hidden"
                            >Loading QR Code...</span
                          >
                        </div>
                        <p class="mt-2 small text-muted">
                          Generating QR Code...
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- QR Code Info -->
                  <div class="qr-info mb-3 p-3 bg-light-navy rounded">
                    <p class="mb-1 small">
                      <strong>Order ID:</strong> {{ order.order_id }}
                    </p>
                    <p class="mb-1 small">
                      <strong>Amount:</strong> {{
                      format_currency(order.total_amount) }}
                    </p>
                    <p class="mb-0 small">
                      <strong>Scan to verify order details</strong>
                    </p>
                  </div>

                  <!-- QR Code Actions -->
                  <div class="d-flex justify-content-center gap-2 flex-wrap">
                    <button
                      class="btn btn-navy btn-sm"
                      onclick="downloadQRCode({{ order.id }})"
                    >
                      <i class="fas fa-download me-1"></i>Download QR
                    </button>
                    <button
                      class="btn btn-outline-navy btn-sm"
                      onclick="refreshQRCode({{ order.id }})"
                    >
                      <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button
                      class="btn btn-yellow btn-sm"
                      onclick="shareOrder()"
                    >
                      <i class="fas fa-share-alt me-1"></i>Share
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row justify-content-center mb-4">
            <div class="col-md-8">
              <div class="card bg-light-navy">
                <div class="card-body">
                  <h5 class="text-navy">Order & Payment Details</h5>
                  <p class="mb-1">
                    <strong>Order ID:</strong>
                    <span class="text-navy">{{ order.order_id }}</span>
                  </p>
                  <p class="mb-1">
                    <strong>Order Date:</strong> {{
                    order.created_at.strftime('%d %b, %Y %I:%M %p') }}
                  </p>
                  <p class="mb-1">
                    <strong>Payment Method:</strong>
                    {% if order.payment_method == 'card' %}
                    <span>Credit/Debit Card</span>
                    <small class="text-muted d-block"
                      >Ending with {{ order.card_last4 if order.card_last4 else
                      '****' }}</small
                    >
                    {% elif order.payment_method == 'upi' %}
                    <span>UPI Payment</span>
                    <small class="text-muted d-block"
                      >{{ order.upi_id if order.upi_id else 'UPI Payment'
                      }}</small
                    >
                    {% elif order.payment_method == 'cod' %}
                    <span>Cash on Delivery</span>
                    <small class="text-muted d-block"
                      >Pay when you receive your order</small
                    >
                    {% else %}
                    <span class="text-capitalize"
                      >{{ order.payment_method }}</span
                    >
                    {% endif %}
                  </p>
                  <p class="mb-1">
                    <strong>Payment Status:</strong>
                    {% if order.payment_status == 'completed' %}
                    <span class="badge bg-success">Paid</span>
                    {% elif order.payment_status == 'pending' and
                    order.payment_method == 'cod' %}
                    <span class="badge bg-yellow text-navy"
                      >Pay on Delivery</span
                    >
                    {% elif order.payment_status == 'pending' %}
                    <span class="badge bg-warning">Pending</span>
                    {% else %}
                    <span class="badge bg-secondary"
                      >{{ order.payment_status|title }}</span
                    >
                    {% endif %}
                  </p>
                  <p class="mb-1">
                    <strong>Total Amount:</strong>
                    <span class="text-navy fw-bold"
                      >{{ format_currency(order.total_amount) }}</span
                    >
                  </p>
                  <p class="mb-0">
                    <strong>Order Status:</strong>
                    <span class="badge bg-yellow text-navy"
                      >{{ order.status|title }}</span
                    >
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Shipping Information -->
          <div class="row justify-content-center mb-4">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header bg-light-navy">
                  <h6 class="mb-0 text-navy">
                    <i class="fas fa-shipping-fast me-2"></i>Shipping
                    Information
                  </h6>
                </div>
                <div class="card-body text-start">
                  <p class="mb-1"><strong>{{ order.shipping_name }}</strong></p>
                  <p class="mb-1">{{ order.shipping_address }}</p>
                  <p class="mb-0">
                    {{ order.shipping_city }}, {{ order.shipping_state }} - {{
                    order.shipping_pincode }}
                  </p>
                  <p class="mb-0">
                    <strong>Phone:</strong> {{ order.shipping_phone if
                    order.shipping_phone else 'Not provided' }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Timeline -->
          <div class="row justify-content-center mb-4">
            <div class="col-md-10">
              <div class="card">
                <div class="card-header bg-light-navy">
                  <h6 class="mb-0 text-navy">
                    <i class="fas fa-clock me-2"></i>Order Timeline
                  </h6>
                </div>
                <div class="card-body">
                  <div class="timeline">
                    <div class="timeline-item completed">
                      <div class="timeline-marker bg-yellow"></div>
                      <div class="timeline-content">
                        <h6 class="mb-1">Order Placed</h6>
                        <small class="text-muted">Just now</small>
                      </div>
                    </div>
                    <div class="timeline-item active">
                      <div class="timeline-marker bg-navy"></div>
                      <div class="timeline-content">
                        <h6 class="mb-1">Processing</h6>
                        <small class="text-muted">Expected: Today</small>
                      </div>
                    </div>
                    <div class="timeline-item">
                      <div class="timeline-marker"></div>
                      <div class="timeline-content">
                        <h6 class="mb-1">Shipped</h6>
                        <small class="text-muted"
                          >Expected: Within 24 hours</small
                        >
                      </div>
                    </div>
                    <div class="timeline-item">
                      <div class="timeline-marker"></div>
                      <div class="timeline-content">
                        <h6 class="mb-1">Delivered</h6>
                        <small class="text-muted"
                          >Expected: {{ get_delivery_date() }}</small
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-grid gap-2 d-md-flex justify-content-center mb-5">
            <a
              href="{{ url_for('track_order') }}?order_id={{ order.order_id }}"
              class="btn btn-navy me-md-2"
            >
              <i class="fas fa-truck me-2"></i>Track Your Order
            </a>
            <a
              href="{{ url_for('print_receipt', order_id=order.id) }}"
              class="btn btn-outline-navy me-md-2"
              target="_blank"
            >
              <i class="fas fa-print me-2"></i>Print Receipt
            </a>
            <button class="btn btn-yellow me-md-2" onclick="shareOrder()">
              <i class="fas fa-share-alt me-2"></i>Share Order
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
              <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
            </a>
          </div>

          <!-- Recommended Products -->
          <div class="row mb-5">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-light-navy">
                  <h5 class="mb-0 text-navy">
                    <i class="fas fa-star me-2 text-yellow"></i>You Might Also
                    Like
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row" id="recommended-products">
                    <!-- Recommended products will be loaded here -->
                    <div class="col-12 text-center">
                      <div class="spinner-border text-navy" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2 text-muted">Loading recommendations...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Social Share -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-light-navy">
                  <h5 class="mb-0 text-navy">
                    <i class="fas fa-share me-2"></i>Share Your Purchase
                  </h5>
                </div>
                <div class="card-body text-center">
                  <p class="mb-3">
                    Excited about your purchase? Share it with your friends!
                  </p>
                  <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <button
                      class="btn btn-share facebook"
                      onclick="shareSocial('facebook')"
                    >
                      <i class="fab fa-facebook-f me-2"></i>Facebook
                    </button>
                    <button
                      class="btn btn-share twitter"
                      onclick="shareSocial('twitter')"
                    >
                      <i class="fab fa-twitter me-2"></i>Twitter
                    </button>
                    <button
                      class="btn btn-share whatsapp"
                      onclick="shareSocial('whatsapp')"
                    >
                      <i class="fab fa-whatsapp me-2"></i>WhatsApp
                    </button>
                    <button
                      class="btn btn-share linkedin"
                      onclick="shareSocial('linkedin')"
                    >
                      <i class="fab fa-linkedin-in me-2"></i>LinkedIn
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- What's Next Section -->
          <div class="mt-5">
            <h5 class="text-navy">What's Next?</h5>
            <div class="row text-start mt-3">
              <div class="col-md-4">
                <div class="text-center">
                  <i class="fas fa-envelope fa-2x text-navy mb-2"></i>
                  <h6>Order Confirmation</h6>
                  <small class="text-muted"
                    >You'll receive an email confirmation shortly</small
                  >
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <i class="fas fa-truck fa-2x text-navy mb-2"></i>
                  <h6>Shipping Updates</h6>
                  <small class="text-muted"
                    >Track your order with the provided ID</small
                  >
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <i class="fas fa-box-open fa-2x text-navy mb-2"></i>
                  <h6>Delivery</h6>
                  <small class="text-muted"
                    >Expected delivery in 3-5 business days</small
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block styles %}
<style>
  :root {
    --navy-blue: #001f3f;
    --navy-blue-dark: #001a35;
    --navy-blue-light: #003366;
    --navy-blue-very-light: #e6f0f9;
    --bright-yellow: #ffd700;
    --bright-yellow-dark: #e6c200;
    --bright-yellow-light: #ffe44d;
  }

  .bg-navy {
    background: linear-gradient(
      135deg,
      var(--navy-blue),
      var(--navy-blue-dark)
    ) !important;
  }

  .text-navy {
    color: var(--navy-blue) !important;
  }

  .btn-navy {
    background: linear-gradient(
      135deg,
      var(--navy-blue),
      var(--navy-blue-dark)
    );
    border-color: var(--navy-blue);
    color: white;
  }

  .btn-navy:hover {
    background: var(--navy-blue-dark);
    border-color: var(--navy-blue-dark);
    color: white;
  }

  .btn-outline-navy {
    border-color: var(--navy-blue);
    color: var(--navy-blue);
  }

  .btn-outline-navy:hover {
    background: var(--navy-blue);
    border-color: var(--navy-blue);
    color: white;
  }

  .bg-yellow {
    background: linear-gradient(
      135deg,
      var(--bright-yellow),
      var(--bright-yellow-dark)
    ) !important;
  }

  .text-yellow {
    color: var(--bright-yellow) !important;
  }

  .btn-yellow {
    background: linear-gradient(
      135deg,
      var(--bright-yellow),
      var(--bright-yellow-dark)
    );
    border-color: var(--bright-yellow);
    color: var(--navy-blue);
    font-weight: 600;
  }

  .btn-yellow:hover {
    background: var(--bright-yellow-dark);
    border-color: var(--bright-yellow-dark);
    color: var(--navy-blue);
  }

  .bg-light-navy {
    background-color: var(--navy-blue-very-light) !important;
  }

  .border-yellow {
    border-color: var(--bright-yellow) !important;
  }

  /* Timeline Styles */
  .timeline {
    position: relative;
    padding-left: 30px;
  }

  .timeline-item {
    position: relative;
    margin-bottom: 20px;
  }

  .timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #dee2e6;
    background: white;
  }

  .timeline-item.completed .timeline-marker {
    background: var(--bright-yellow);
    border-color: var(--bright-yellow);
  }

  .timeline-item.active .timeline-marker {
    background: var(--navy-blue);
    border-color: var(--navy-blue);
    animation: pulse 2s infinite;
  }

  .timeline-content {
    padding-bottom: 10px;
  }

  /* Social Share Buttons */
  .btn-share {
    border: 2px solid;
    border-radius: 25px;
    padding: 8px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-share.facebook {
    border-color: #1877f2;
    color: #1877f2;
  }

  .btn-share.facebook:hover {
    background: #1877f2;
    color: white;
  }

  .btn-share.twitter {
    border-color: #1da1f2;
    color: #1da1f2;
  }

  .btn-share.twitter:hover {
    background: #1da1f2;
    color: white;
  }

  .btn-share.whatsapp {
    border-color: #25d366;
    color: #25d366;
  }

  .btn-share.whatsapp:hover {
    background: #25d366;
    color: white;
  }

  .btn-share.linkedin {
    border-color: #0077b5;
    color: #0077b5;
  }

  .btn-share.linkedin:hover {
    background: #0077b5;
    color: white;
  }

  /* Product Cards */
  .product-card {
    border: 1px solid var(--navy-blue-very-light);
    border-radius: 10px;
    transition: all 0.3s ease;
    height: 100%;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 31, 63, 0.1);
  }

  .product-image {
    height: 120px;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(0, 31, 63, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(0, 31, 63, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(0, 31, 63, 0);
    }
  }
</style>
{% endblock %}{% block scripts %}
<!-- QR Code Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    // Global variables
    let qrCodeInstance = null;
    let currentOrderId = {{ order.id }};

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Order Confirmation Page Loaded');

      // Load QR code for current order
      loadQRCode(currentOrderId);

      // Load recommended products
      loadRecommendedProducts();

      // Initialize social sharing buttons
      initializeSocialSharing();
    });

    // ==================== QR CODE FUNCTIONS ====================

    // Load QR Code from Server
    function loadQRCode(orderId) {
      const qrContainer = document.getElementById('qrcode');

      // Show loading state
      qrContainer.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-navy" role="status">
            <span class="visually-hidden">Loading QR Code...</span>
          </div>
          <p class="mt-2 small text-muted">Generating QR Code...</p>
        </div>
      `;

      // First try to get QR data from server
      fetch(`/api/qr-data/${orderId}`)
        .then(response => {
          if (!response.ok) throw new Error('Server response not ok');
          return response.json();
        })
        .then(data => {
          if (data.success && data.qr_data) {
            generateQRCode(data.qr_data);
          } else {
            throw new Error(data.message || 'Invalid QR data');
          }
        })
        .catch(error => {
          console.warn('Server QR data failed, using fallback:', error);
          // Fallback: generate QR with basic order info
          const fallbackData = {
            merchant: "NexaMart",
            order_id: "{{ order.order_id }}",
            amount: {{ order.total_amount }},
            currency: "INR",
            date: "{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}",
            status: "{{ order.status }}",
            payment_method: "{{ order.payment_method }}",
            customer: "{{ current_user.email }}",
            message: "Scan to verify NexaMart order details"
          };
          generateQRCode(fallbackData);
        });
    }

    // Generate QR Code using JavaScript
    function generateQRCode(qrData) {
      const qrContainer = document.getElementById('qrcode');

      // Clear container
      qrContainer.innerHTML = '';

      try {
        // Convert data to string format
        const qrText = formatQRData(qrData);

        // Generate QR code
        qrCodeInstance = new QRCode(qrContainer, {
          text: qrText,
          width: 200,
          height: 200,
          colorDark: "#001f3f",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.Q
        });

        console.log('QR Code generated successfully');

        // Add success styling
        setTimeout(() => {
          qrContainer.style.border = '2px solid #ffd700';
          qrContainer.style.borderRadius = '10px';
          qrContainer.style.padding = '10px';
        }, 100);

      } catch (error) {
        console.error('QR Code generation failed:', error);
        showFallbackQRDisplay();
      }
    }

    // Format QR data for better readability
    function formatQRData(data) {
      if (typeof data === 'string') return data;

      // Create a clean, readable format
      return `NEXAMART ORDER VERIFICATION
  📦 Order ID: {{ order.order_id }}
  💰 Amount: {{ format_currency(order.total_amount) }}
  📅 Date: {{ order.created_at.strftime('%d %b, %Y') }}
  🔄 Status: {{ order.status|title }}
  💳 Payment: {{ order.payment_method|upper }}
  👤 Customer: {{ current_user.email }}
  🔗 Verify: {{ request.host_url }}verify-order/{{ order.order_id }}`;
    }

    // Show fallback when QR generation fails
    function showFallbackQRDisplay() {
      const qrContainer = document.getElementById('qrcode');
      qrContainer.innerHTML = `
        <div class="text-center p-4 border rounded bg-light">
          <i class="fas fa-receipt fa-3x text-navy mb-3"></i>
          <h6 class="text-navy mb-2">Order Details</h6>
          <p class="mb-1 small"><strong>Order ID:</strong> {{ order.order_id }}</p>
          <p class="mb-1 small"><strong>Amount:</strong> {{ format_currency(order.total_amount) }}</p>
          <p class="mb-1 small"><strong>Date:</strong> {{ order.created_at.strftime('%d %b, %Y') }}</p>
          <p class="mb-0 small"><strong>Status:</strong> {{ order.status|title }}</p>
        </div>
      `;
    }

    // Download QR Code
    function downloadQRCode(orderId) {
      const button = event.target;
      const originalText = button.innerHTML;

      // Show loading state
      button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Downloading...';
      button.disabled = true;

      // Try server download first
      fetch(`/api/download-qr/${orderId}`)
        .then(response => {
          if (response.ok) return response.blob();
          throw new Error('Server download failed');
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `nexamart-order-{{ order.order_id }}-qrcode.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          showToast('QR Code downloaded successfully!', 'success');
        })
        .catch(error => {
          console.warn('Server download failed, trying client-side:', error);
          // Fallback: client-side download from canvas
          downloadQRFromCanvas();
        })
        .finally(() => {
          // Restore button state
          button.innerHTML = originalText;
          button.disabled = false;
        });
    }

    // Client-side QR code download from canvas
    function downloadQRFromCanvas() {
      try {
        const canvas = document.querySelector('#qrcode canvas');
        if (canvas) {
          const link = document.createElement('a');
          link.download = `nexamart-order-{{ order.order_id }}-qrcode.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
          showToast('QR Code downloaded!', 'success');
        } else {
          throw new Error('Canvas not found');
        }
      } catch (error) {
        console.error('Client-side download failed:', error);
        showToast('Failed to download QR code. Please try refreshing the page.', 'error');
      }
    }

    // Refresh QR Code
    function refreshQRCode(orderId) {
      const button = event.target;
      const originalText = button.innerHTML;

      button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
      button.disabled = true;

      // Clear existing QR
      const qrContainer = document.getElementById('qrcode');
      qrContainer.innerHTML = '';
      qrContainer.style.border = 'none';

      // Reload QR code
      loadQRCode(orderId);

      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('QR Code refreshed!', 'success');
      }, 1500);
    }

    // ==================== RECOMMENDED PRODUCTS ====================

    // Load Recommended Products
    function loadRecommendedProducts() {
      const container = document.getElementById('recommended-products');

      // Show loading state
      container.innerHTML = `
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-navy" role="status">
            <span class="visually-hidden">Loading recommendations...</span>
          </div>
          <p class="mt-2 text-muted">Finding products you might like...</p>
        </div>
      `;

      // Try to load from API
      fetch('/api/recommended-products?order_id={{ order.id }}')
        .then(response => {
          if (!response.ok) throw new Error('API not available');
          return response.json();
        })
        .then(products => {
          if (products && products.length > 0) {
            displayRecommendedProducts(products);
          } else {
            showFallbackProducts();
          }
        })
        .catch(error => {
          console.log('API failed, showing fallback products:', error);
          showFallbackProducts();
        });
    }

    // Display recommended products
    function displayRecommendedProducts(products) {
      const container = document.getElementById('recommended-products');

      container.innerHTML = products.map(product => `
        <div class="col-md-3 col-6 mb-3">
          <div class="card product-card h-100 border-0 shadow-sm">
            <img src="${product.image_url || '{{ url_for("static", filename="images/placeholder.jpg") }}'}"
                 class="card-img-top product-image"
                 alt="${product.name}"
                 onerror="this.src='{{ url_for("static", filename="images/placeholder.jpg") }}'">
            <div class="card-body p-3">
              <h6 class="card-title small text-dark mb-2">${product.name}</h6>
              <p class="card-text text-navy fw-bold mb-3">${product.price}</p>
              <button class="btn btn-yellow btn-sm w-100" onclick="addToCart(${product.id})">
                <i class="fas fa-cart-plus me-1"></i>Add to Cart
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Show fallback products when API fails
    function showFallbackProducts() {
      const fallbackProducts = [
        {
          id: 101,
          name: "Wireless Bluetooth Earbuds",
          price: "₹1,999",
          image_url: "{{ url_for('static', filename='images/placeholder.jpg') }}"
        },
        {
          id: 102,
          name: "Phone Case & Cover",
          price: "₹499",
          image_url: "{{ url_for('static', filename='images/placeholder.jpg') }}"
        },
        {
          id: 103,
          name: "Tempered Glass Screen Guard",
          price: "₹299",
          image_url: "{{ url_for('static', filename='images/placeholder.jpg') }}"
        },
        {
          id: 104,
          name: "Fast Charging Cable",
          price: "₹799",
          image_url: "{{ url_for('static', filename='images/placeholder.jpg') }}"
        }
      ];

      displayRecommendedProducts(fallbackProducts);
    }

    // ==================== CART FUNCTIONALITY ====================

    // Add to Cart Function
    function addToCart(productId) {
      const button = event.target;
      const originalText = button.innerHTML;

      // Show loading state
      button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
      button.disabled = true;

      fetch('/add_to_cart/' + productId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'quantity=1'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success state
          button.innerHTML = '<i class="fas fa-check me-1"></i>Added!';
          button.classList.remove('btn-yellow');
          button.classList.add('btn-success');

          showToast('Product added to cart successfully!', 'success');

          // Reset button after 2 seconds
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-yellow');
            button.disabled = false;
          }, 2000);
        } else {
          throw new Error(data.message || 'Failed to add to cart');
        }
      })
      .catch(error => {
        console.error('Add to cart error:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('Failed to add product to cart. Please try again.', 'error');
      });
    }

    // ==================== SOCIAL SHARING ====================

    // Initialize social sharing
    function initializeSocialSharing() {
      // Add click listeners to social buttons
      document.querySelectorAll('.btn-share').forEach(btn => {
        const platform = btn.classList[1]; // facebook, twitter, etc.
        btn.addEventListener('click', () => shareSocial(platform));
      });
    }

    // Share Order on Social Media
    function shareSocial(platform) {
      const shareText = `I just bought this from NexaMart! 🛍️\nOrder: #{{ order.order_id }}\nAmount: {{ format_currency(order.total_amount) }}\nThank you for shopping with us! ✨`;
      const shareUrl = encodeURIComponent(window.location.href);
      const text = encodeURIComponent(shareText);

      let shareUrlTemplate = '';

      switch(platform) {
        case 'facebook':
          shareUrlTemplate = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${text}`;
          break;
        case 'twitter':
          shareUrlTemplate = `https://twitter.com/intent/tweet?text=${text}&url=${shareUrl}`;
          break;
        case 'whatsapp':
          shareUrlTemplate = `https://wa.me/?text=${text}%20${shareUrl}`;
          break;
        case 'linkedin':
          shareUrlTemplate = `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`;
          break;
        default:
          console.warn('Unknown platform:', platform);
          return;
      }

      // Open share window
      window.open(shareUrlTemplate, '_blank', 'width=600,height=400,menubar=no,toolbar=no,resizable=yes,scrollbars=yes');
    }

    // Native Share (for mobile devices)
    function shareOrder() {
      const shareData = {
        title: 'My NexaMart Purchase',
        text: `I just purchased from NexaMart! 🛍️\nOrder: #{{ order.order_id }}\nAmount: {{ format_currency(order.total_amount) }}\nDate: {{ order.created_at.strftime('%d %b %Y') }}`,
        url: window.location.href
      };

      if (navigator.share && navigator.canShare(shareData)) {
        navigator.share(shareData)
          .then(() => console.log('Order shared successfully'))
          .catch(err => {
            console.log('Sharing cancelled or failed:', err);
            // Fallback to clipboard
            copyToClipboard(shareData.text + '\n' + shareData.url);
          });
      } else {
        // Fallback: copy to clipboard
        copyToClipboard(shareData.text + '\n' + shareData.url);
      }
    }

    // Copy to Clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => showToast('Order details copied to clipboard! 📋', 'success'))
        .catch(err => {
          console.error('Clipboard failed:', err);
          showToast('Failed to copy to clipboard', 'error');
        });
    }

    // ==================== UTILITY FUNCTIONS ====================

    // Toast Notification System
    function showToast(message, type = 'info') {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.custom-toast');
      existingToasts.forEach(toast => toast.remove());

      const icon = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-triangle',
        'info': 'fa-info-circle',
        'warning': 'fa-exclamation-circle'
      }[type] || 'fa-info-circle';

      const bgColor = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'info': 'alert-info',
        'warning': 'alert-warning'
      }[type] || 'alert-info';

      const toast = document.createElement('div');
      toast.className = `custom-toast alert ${bgColor} alert-dismissible fade show`;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
        border-radius: 8px;
      `;

      toast.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fas ${icon} me-2 fs-5"></i>
          <span class="flex-grow-1">${message}</span>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
        </div>
      `;

      document.body.appendChild(toast);

      // Auto remove after 4 seconds
      setTimeout(() => {
        if (toast.parentNode) {
          toast.classList.remove('show');
          setTimeout(() => toast.parentNode.removeChild(toast), 300);
        }
      }, 4000);
    }

    // ==================== EVENT LISTENERS ====================

    // Add global error handler
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
      showToast('Something went wrong. Please refresh the page.', 'error');
    });

    // Add page visibility change handler
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // Page became visible, refresh QR code if it's empty
        const qrContainer = document.getElementById('qrcode');
        if (qrContainer.innerHTML.trim() === '') {
          loadQRCode(currentOrderId);
        }
      }
    });

    console.log('Order Confirmation Scripts Loaded Successfully');
</script>
{% endblock %}
